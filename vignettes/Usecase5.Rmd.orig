---
title: "Use Case 5: Analysis of trials (including methods for analysing contamination)"
output:
  rmarkdown::html_vignette:
  toc: true
vignette: >
  %\VignetteIndexEntry{Use Case 5: Analysis of trials (including methods for analysing contamination)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
<!--To build the vignette
# since the vignette takes a long time to run, it is not run with every build
# as suggested here https://ropensci.org/blog/2019/12/08/precompute-vignettes/
# to Knit this vignette without this time consuming step being part of the default build
knitr::knit("vignettes/Usecase5.Rmd.orig", output = "vignettes/Usecase5.Rmd")
rmarkdown.html_vignette.check_title = FALSE
devtools::install(build_vignettes = TRUE)
-->

The [`CRTanalysis()`](../reference/CRTanalysis.html) function is a wrapper for different statistical analysis packages that can be used to analyse either simulated or real trial datasets. It is designed for use in simulation studies of different analytical methods for spatial CRTs by automating the data processing and selecting some appropriate analysis options. It does not replace conventional use of these packages. Real field trials very often entail complications that are not catered for any of the analysis options in `CRTanalysis()` and it does not aspire to carry out the full analytical workflow for a trial. It can be used as part of a wider workflow. In particular the usual object output by the statistical analysis package constitutes the `model_object` element within the `CRTanalysis` object generated by `CRTanalysis()`. This can be accessed by the usual methods (e.g `predict()`, `summary()`, `plot()`) which can be required for assessing goodness of fit and the need for specific additional analyses.

## Statistical Methods

The options that can be specified using the `method` parameter in the function call are:

+ `method = "T"` summarises the outcome at the level of the cluster, and uses 2-sample t-tests to carry out statistical significance tests of the effect, and to compute confidence intervals for the effect size. The [t.test](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/t.test) function in the `stats` package is used.
+	`method = "GEE"` uses Generalised Estimating Equations to estimate the efficacy in a model with iid random effects for the clusters. An estimate of the intracluster correlation (ICC) is also provided. This uses calls to the [geepack](https://www.jstatsoft.org/article/view/v015i02) package.
+	`method = "LME4"` fits linear (for continuous data) or generalized linear (for counts and proportions) mixed models with iid random effects for clusters in [lme4](https://cran.r-project.org/web/packages/lme4/lme4.pdf).
+ `method = "MCMC"` uses Markov chain Monte Carlo simulation in package [jagsUI](https://cran.r-project.org/web/packages/jagsUI/index.html), which calls r-JAGS.
+ `method = "INLA"`uses approximate Bayesian inference via the [R-INLA package](https://www.r-inla.org/). This provides functionality for geostatistical analysis, which can be used for geographical mapping of model outputs (as illustrated in . INLA spatial analysis requires a prediction mesh. This can be generated using [`CRTspat::new_mesh()`](../reference/new_mesh().html). This can be computationally expensive, so it is recommended to compute the mesh just once for each dataset.

All these analysis methods can be used to carry out a simple comparision of outcomes between trial arms. Each offers different additional functionality, and has its own limitations (see Table 5.1). Some of these limitations are specific to the options offered within `CRTanalysis()`, which does not embrace the full range of options of the packages that are 'wrapped'These are specified using the `method` argument of the function.

Table 5.1. Available statistical methods

| `method` | Package | What the `CRTanalysis()` implementation offers |Limitations (as implemented) |
|----------|---------|------------------------------------------------|-----------------------------|
| `T`| [t.test](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/t.test) | P-values and confidence intervals for efficacy based on comparison of cluster means | No analysis of contamination or degree of clustering |
| `GEE` | [geepack](https://www.jstatsoft.org/article/view/v015i02) | Interval estimates for efficacy and Intra-cluster correlations | No analysis of contamination or degree of clustering |
| `LME4`| [lme4](https://cran.r-project.org/web/packages/lme4/lme4.pdf) | Analysis of contamination | No geostatistical analysis |
| `INLA` | [INLA](https://www.r-inla.org/) | Analysis of contamination, geostatistical analysis and spatially structured outputs | Computationally intensive |
| `MCMC` | [jagsUI](https://cran.r-project.org/web/packages/jagsUI/index.html) | Interval estimates for contamination parameters | Identifiability issues and slow convergence are possible |

For the analysis of proportions, the outcome in the control arm is estimated as: $\hat{p}_{C} = \frac{1}{1 + exp(-\beta_1)}$, in the intervention arm as $\hat{p}_{I} = \frac{1}{1 + exp(-\beta_1-\beta_2)}$, and the efficacy is estimated as $\tilde{E}_{s} = 1- \frac{\tilde{p}_{I}}{\tilde{p}_{C}}$ where $beta_1$ is the intercept term and $\beta_2$ the incremental effect associated with the intervention.

`summary("<analysis>"")` is used to view the key results of the trial. To display the
output from the statistical procedure that is called, try `<analysis>$model_object` or
`summary("<analysis>$model_object")`.

```{r example5a.r, fig.keep = 'none', echo = TRUE}
library(CRTspat)
example <- readdata("exampleCRT.txt")
analysisT <- CRTanalysis(example, method = "T")
summary(analysisT)
analysisT$model_object
```

## Contamination (spillover)

Contamination between arms, or spillover effects can be included in the models by assuming the effects to
be a function of distance to the opposing arm of the trial. The functional forms of for this relationship
is specified by the value of  `cfunc` (Table 5.2). In addition, models that do not consider contamination can be
fitted using options `Z` and `X`. These are included both to allow conventional analyses, and also to enable
model selection using the Akaike information criterion (AIC) or Bayesian information criterion (BIC) and likelihood ratio tests.

Table 5.2. Available contamination functions

| `cfunc` | Description | Formula for $P\left( d \right)$ | Compatible `method`(s)   |
|---------|------------------|--------------------------|--------------------------|
| `Z`| No intervention effect | $P\left( d \right) = \ 0\ $ | `GEE` `LME4` `INLA` `MCMC` |
| `X`| Simple intervention effect |  $\begin{matrix}
     P\left( d \right) = \ 0\ for\ d\  < \ 0 \\
     P\left( d \right) = \ 1\ for\ d\  > \ 0 \\
     \end{matrix}\ $ | `T` `GEE` `LME4` `INLA` `MCMC` |
| `L`| inverse logistic (sigmoid)|  $P\left( d \right) = \ \frac{1}{\left( 1\  + \ exp\left( - \beta d \right) \right)}$ | `LME4` `INLA` `MCMC`  |
| `P`| inverse probit (error function) | $P\left( d \right) = \frac{1}{2}\left( 1\  + \ erf\left( \frac{\text{Î²d}}{\sqrt{2}} \right) \right)$ | `LME4` `INLA` `MCMC`  |
| `S`| piecewise linear | $\begin{matrix}
    P\left( d \right) = \ 0\  for\ d\  < \  - \beta\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  \ \ \ \ \ \ \ \ \\
    P\left( d \right) = \ \beta\left( 1\  + \ d \right)\ for\  - \beta < d\  < \ \beta\\
    P\left( d \right) = \ 1\  for\ d\  > \ \beta\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  \ \ \\
    \end{matrix}\ $ | `MCMC` |

Fitted curves for the example dataset

```{r example5b.r, fig.keep = 'none', echo = TRUE}
analysisLME4_Z <- CRTanalysis(example, method = "LME4", cfunc = "Z")
summary(analysisLME4_Z)
analysisLME4_X <- CRTanalysis(example, method = "LME4", cfunc = "X")
summary(analysisLME4_X)
analysisLME4_P <- CRTanalysis(example, method = "LME4", cfunc = "P")
summary(analysisLME4_P)
analysisLME4_L <- CRTanalysis(example, method = "LME4", cfunc = "L")
summary(analysisLME4_L)
analysisLME4_S <- CRTanalysis(example, method = "LME4", cfunc = "S")
summary(analysisLME4_S)
p1 <- plotCRT(analysisLME4_X, map = FALSE)
p2 <- plotCRT(analysisLME4_P, map = FALSE)
p3 <- plotCRT(analysisLME4_L, map = FALSE)
p4 <- plotCRT(analysisLME4_S, map = FALSE)
library(cowplot)
plot_grid(p1, p2, p3, p4, labels = c('X', 'P', 'L', 'S'), label_size = 12, ncol = 2)
```
<p>
  <img src="example5b.r-2.png"> <br>
  <em>Fig 5.1 Analysis with option "X" (usual analysis ignoring contamination)</em>
</p>
<p>
  <img src="example5b.r-3.png"> <br>
  <em>Fig 5.2 Analysis with option "P" (error function contamination model)</em>
</p>
<p>
  <img src="example5b.r-4.png"> <br>
  <em>Fig 5.3 Analysis with option "L" (sigmoid (logistic) contamination model)</em>
</p>
<p>
  <img src="example5b.r-5.png"> <br>
  <em>Fig 5.4 Analysis with option "S" (piecewise linear contamination model)</em>
</p>

Note that the piecewise linear contamination function is only linear on the scale of the linear predictor.
When used in a logistic model the transformation via the inverse of the link function leads to a smooth curvilinear
plot (Figure 5.4).



To create a 100m INLA mesh for `<MyTrial>`, use:

`mesh <- new_mesh(trial = <MyTrial> , pixel = 0.1)`









