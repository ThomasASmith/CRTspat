---
title: "Use Case 5: Analysis of trials (including methods for analysing contamination)"
output:
  rmarkdown::html_vignette:
  toc: true
vignette: >
  %\VignetteIndexEntry{Use Case 5: Analysis of trials (including methods for analysing contamination)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
<!--To build the vignette
# since the vignette takes a long time to run, it is not run with every build
# as suggested here https://ropensci.org/blog/2019/12/08/precompute-vignettes/
# to Knit this vignette without this time consuming step being part of the default build
knitr::knit("vignettes/Usecase5.Rmd.orig", output = "vignettes/Usecase5.Rmd")
rmarkdown.html_vignette.check_title = FALSE
devtools::install(build_vignettes = TRUE)
-->

The [`CRTanalysis()`](../reference/CRTanalysis.html) function is a wrapper for different statistical analysis packages that can be used to analyse either simulated or real trial datasets. It is designed for use in simulation studies of different analytical methods for spatial CRTs by automating the data processing and selecting some appropriate analysis options. It does not replace conventional use of these packages. Real field trials very often entail complications that are not catered for any of the analysis options in `CRTanalysis()` and it does not aspire to carry out the full analytical workflow for a trial. It can be used as part of a wider workflow. In particular the usual object output by the statistical analysis package constitutes the `model_object` element within the `CRTanalysis` object generated by `CRTanalysis()`. This can be accessed by the usual methods (e.g `predict()`, `summary()`, `plot()`) which may be needed for diagnosing errors, assessing goodness of fit, and for identifying needs for additional analyses.

## Statistical Methods

The options that can be specified using the `method` parameter in the function call are:

+ `method = "T"` summarises the outcome at the level of the cluster, and uses 2-sample t-tests to carry out statistical significance tests of the effect, and to compute confidence intervals for the effect size. The [t.test](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/t.test) function in the `stats` package is used.
+	`method = "GEE"` uses Generalised Estimating Equations to estimate the efficacy in a model with iid random effects for the clusters. An estimate of the intracluster correlation (ICC) is also provided. This uses calls to the [geepack](https://www.jstatsoft.org/article/view/v015i02) package.
+	`method = "LME4"` fits linear (for continuous data) or generalized linear (for counts and proportions) mixed models with iid random effects for clusters in [lme4](https://cran.r-project.org/web/packages/lme4/lme4.pdf).
+ `method = "MCMC"` uses Markov chain Monte Carlo simulation in package [jagsUI](https://cran.r-project.org/web/packages/jagsUI/index.html), which calls r-JAGS.
+ `method = "INLA"` uses approximate Bayesian inference via the [R-INLA package](https://www.r-inla.org/). This provides functionality for geostatistical analysis, which can be used for geographical mapping of model outputs (as illustrated in . INLA spatial analysis requires a prediction mesh. This can be generated using [`CRTspat::new_mesh()`](../reference/new_mesh().html). This can be computationally expensive, so it is recommended to compute the mesh just once for each dataset.

All these analysis methods can be used to carry out a simple comparision of outcomes between trial arms. Each offers different additional functionality, and has its own limitations (see Table 5.1). Some of these limitations are specific to the options offered within `CRTanalysis()`, which does not embrace the full range of options of the packages that are 'wrapped'. These are specified using the `method` argument of the function.

Table 5.1. Available statistical methods

| `method` | Package | What the `CRTanalysis()` implementation offers |Limitations (as implemented) |
|----------|---------|------------------------------------------------|-----------------------------|
| `T`| [t.test](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/t.test) | P-values and confidence intervals for efficacy based on comparison of cluster means | No analysis of contamination or degree of clustering |
| `GEE` | [geepack](https://www.jstatsoft.org/article/view/v015i02) | Interval estimates for efficacy and Intra-cluster correlations | No analysis of contamination or degree of clustering |
| `LME4`| [lme4](https://cran.r-project.org/web/packages/lme4/lme4.pdf) | Analysis of contamination | No geostatistical analysis |
| `INLA` | [INLA](https://www.r-inla.org/) | Analysis of contamination, geostatistical analysis and spatially structured outputs | Computationally intensive |
| `MCMC` | [jagsUI](https://cran.r-project.org/web/packages/jagsUI/index.html) | Interval estimates for contamination parameters | Identifiability issues and slow convergence are possible |

For the analysis of proportions, the outcome in the control arm is estimated as: $\hat{p}_{C} = \frac{1}{1 + exp(-\beta_1)}$, in the intervention arm as $\hat{p}_{I} = \frac{1}{1 + exp(-\beta_1-\beta_2)}$, and the efficacy is estimated as $\tilde{E}_{s} = 1- \frac{\tilde{p}_{I}}{\tilde{p}_{C}}$ where $\beta_1$ is the intercept term and $\beta_2$ the incremental effect associated with the intervention.

`summary("<analysis>"")` is used to view the key results of the trial. To display the
output from the statistical procedure that is called, try `<analysis>$model_object` or
`summary("<analysis>$model_object")`.


```r
library(CRTspat)
example <- readdata("exampleCRT.txt")
analysisT <- CRTanalysis(example, method = "T")
summary(analysisT)
```

```
## =====================CLUSTER RANDOMISED TRIAL ANALYSIS =================
## Analysis method:  T 
## Link function:  logit 
## Model formula:  arm + (1 | cluster) 
## No modelling of contamination 
## Estimates:      Control:  0.364  (95% CL:  0.286 0.451 )
##            Intervention:  0.21  (95% CL:  0.147 0.292 )
##                Efficacy:  0.423  (95% CL:  0.208 0.727 )
##  
## P-value (2-sided):  0.006879064
```

```r
analysisT$model_object
```

```
## 
## 	Two Sample t-test
## 
## data:  lp by arm
## t = 2.9818, df = 22, p-value = 0.006879
## alternative hypothesis: true difference in means between group control and group intervention is not equal to 0
## 95 percent confidence interval:
##  0.2332638 1.2989425
## sample estimates:
##      mean in group control mean in group intervention 
##                 -0.5561662                 -1.3222694
```

## Assessing model fit

The `model = "LME4"` option outputs the deviance of the model and the Akaike information criterion (AIC), which can be
used to select the best fitting model. The deviance information criterion (DIC) and Bayesian information criterion (BIC) perform the same role for the Bayesian methods (`"INLA"`, and `"MCMC"`).  The comparison of results with `cfunc = "X"` and `cfunc = "Z"` is used to assess whether the intervention effect is likely to be due to chance. With `method = "T"`, `cfunc = "X"` provides a significance test of the intervention effect directly. The models with contamination (see below) can be compared by that with `cfunc = "X"` to evaluate whether contamination
has led to an important bias.

## Geostatistical models

To carry out a geostatistical analysis with `method = "INLA"` a prediction mesh is needed. By default a very low
resolution mesh is created (creating a high resolution mesh is computationally expensive). To create a 100m INLA mesh
for `<MyTrial>`, use:

`mesh <- new_mesh(trial = <MyTrial> , pixel = 0.1)`

## Contamination (spillover)

Contamination between arms, or spillover effects can be included in the models by assuming the effects to
be a function of distance to the opposing arm of the trial. The functional forms of for this relationship
is specified by the value of  `cfunc` (Table 5.2). In addition, models that do not consider contamination can be
fitted using options `Z` and `X`. These are included both to allow conventional analyses, and also to enable
model selection using the Akaike information criterion (AIC) or Bayesian information criterion (BIC) and likelihood ratio tests.

Table 5.2. Available contamination functions

| `cfunc` | Description | Formula for $P\left( d \right)$ | Compatible `method`(s)   |
|---------|------------------|--------------------------|--------------------------|
| `Z`| No intervention effect | $P\left( d \right) = \ 0\ $ | `GEE` `LME4` `INLA` `MCMC` |
| `X`| Simple intervention effect |  $\begin{matrix}
     P\left( d \right) = \ 0\ for\ d\  < \ 0 \\
     P\left( d \right) = \ 1\ for\ d\  > \ 0 \\
     \end{matrix}\ $ | `T` `GEE` `LME4` `INLA` `MCMC` |
| `L`| inverse logistic (sigmoid)|  $P\left( d \right) = \ \frac{1}{\left( 1\  + \ exp\left( - \beta d \right) \right)}$ | `LME4` `INLA` `MCMC`  |
| `P`| inverse probit (error function) | $P\left( d \right) = \frac{1}{2}\left( 1\  + \ erf\left( \frac{\text{Î²d}}{\sqrt{2}} \right) \right)$ | `LME4` `INLA` `MCMC`  |
| `S`| piecewise linear | $\begin{matrix}
    P\left( d \right) = \ 0\  for\ d\  < \  - \beta/2\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  \ \ \ \ \ \ \ \ \\
    P\left( d \right) = \ \left(\beta/2\  + \ d \right)/\beta\ for\  - \beta/2 < d\  < \ \beta/2\\
    P\left( d \right) = \ 1\  for\ d\  > \ \beta/2\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  \ \ \\
    \end{matrix}\ $ | `LME4` `INLA` `MCMC` |

The different values for `cfunc` lead to the fitted curves shown in Figure 5.1. The light blue shaded part of the
plot corresponds to the contamination interval, in those cases where this is estimated.


```r
analysisLME4_Z <- CRTanalysis(example, method = "LME4", cfunc = "Z")
summary(analysisLME4_Z)
```

```
## =====================CLUSTER RANDOMISED TRIAL ANALYSIS =================
## Analysis method:  LME4 
## Link function:  logit 
## Model formula:  (1 | cluster) 
## No comparison of arms 
## Estimates:      Control:  0.285  (95% CL:  NA )
## deviance:  1387.609 
## AIC     :  1391.609
```

```r
analysisLME4_X <- CRTanalysis(example, method = "LME4", cfunc = "X")
summary(analysisLME4_X)
```

```
## =====================CLUSTER RANDOMISED TRIAL ANALYSIS =================
## Analysis method:  LME4 
## Link function:  logit 
## Model formula:  arm + (1 | cluster) 
## No modelling of contamination 
## Estimates:      Control:  0.366  (95% CL:  0.292 0.449 )
##            Intervention:  0.216  (95% CL:  0.162 0.281 )
##                Efficacy:  0.41  (95% CL:  0.165 0.584 )
## deviance:  1379.898 
## AIC     :  1385.898
```

```r
analysisLME4_P <- CRTanalysis(example, method = "LME4", cfunc = "P")
summary(analysisLME4_P)
```

```
## =====================CLUSTER RANDOMISED TRIAL ANALYSIS =================
## Analysis method:  LME4 
## Link function:  logit 
## Measure of distance or surround:  Nearest discordant location 
## Model formula:  pvar + (1 | cluster) 
## Error function model for contamination
## Estimates:      Control:  0.418  (95% CL:  0.331 0.508 )
##            Intervention:  0.186  (95% CL:  0.136 0.25 )
##                Efficacy:  0.552  (95% CL:  0.326 0.702 )
## Contamination range(km):  1.73  (95% CL:  1.7 1.74 )
## % locations contaminated: 68.2  (95% CL:  67.7 68.8  %)
## deviance:  1374.215 
## AIC     :  1382.215 including penalty for the contamination scale parameter
```

```r
analysisLME4_L <- CRTanalysis(example, method = "LME4", cfunc = "L")
summary(analysisLME4_L)
```

```
## =====================CLUSTER RANDOMISED TRIAL ANALYSIS =================
## Analysis method:  LME4 
## Link function:  logit 
## Measure of distance or surround:  Nearest discordant location 
## Model formula:  pvar + (1 | cluster) 
## Sigmoid (logistic) function for contamination
## Estimates:      Control:  0.417  (95% CL:  0.331 0.509 )
##            Intervention:  0.186  (95% CL:  0.136 0.249 )
##                Efficacy:  0.551  (95% CL:  0.328 0.699 )
## Contamination range(km):  1.78  (95% CL:  1.76 1.8 )
## % locations contaminated: 70  (95% CL:  69.5 70.8  %)
## deviance:  1374.201 
## AIC     :  1382.201 including penalty for the contamination scale parameter
```

```r
analysisLME4_S <- CRTanalysis(example, method = "LME4", cfunc = "S")
summary(analysisLME4_S)
```

```
## =====================CLUSTER RANDOMISED TRIAL ANALYSIS =================
## Analysis method:  LME4 
## Link function:  logit 
## Measure of distance or surround:  Nearest discordant location 
## Model formula:  pvar + (1 | cluster) 
## Piecewise linear function for contamination
## Estimates:      Control:  0.391  (95% CL:  0.312 0.472 )
##            Intervention:  0.197  (95% CL:  0.147 0.259 )
##                Efficacy:  0.493  (95% CL:  0.281 0.648 )
## Contamination range(km):  1.65  (95% CL:  1.64 1.65 )
## % locations contaminated: 64.6  (95% CL:  64.6 64.8  %)
## deviance:  1374.44 
## AIC     :  1382.44 including penalty for the contamination scale parameter
```

```r
p1 <- plotCRT(analysisLME4_X, map = FALSE)
p2 <- plotCRT(analysisLME4_P, map = FALSE)
p3 <- plotCRT(analysisLME4_L, map = FALSE)
p4 <- plotCRT(analysisLME4_S, map = FALSE)
library(cowplot)
plot_grid(p1, p2, p3, p4, labels = c('X', 'P', 'L', 'S'), label_size = 12, ncol = 2)
```
<p>
  <img src="example5b.r-1.png"> <br>
  <em>Fig 5.1 Fitted curves for the example dataset with different options for `cfunc`</em>
</p>

Note that the piecewise linear contamination function, `cfunc = "S"`, is only linear on the scale of the linear predictor. When used in a logistic model, as here, the transformation via the inverse of the link function leads to a slightly curved plot (Figure 5.4S).

The full set of different `cfunc` options are available for each of model options `"LME4"`, `"INLA"`, and `"MCMC"`.
The performance of all these different models has not yet been thoroughly investigated. The analyses of [Multerer *et al.* (2021b)](https://malariajournal.biomedcentral.com/articles/10.1186/s12936-021-03924-7) found that that a model equivalent to  `method = "MCMC"`, `cfunc = "L"` gave estimates of efficacy with low bias, even in simulations with considerable contamination.














